#!/bin/bash
export PATH="/bin:/usr/bin"

function usage {
	echo "Usage: ${0##*/} [-r] scores_file"
}

while getopts 'r' opt; do
	case "$opt" in
		r)
			reverse="true"
			shift
			;;
		*)
			usage >&2
			exit 1
			;;
	esac
done

if [[ $# -ne 1 ]]; then
	usage >&2
	exit 1
fi

function readlog {
	local IFS=":" v="$*"
	set -- $v
	unset IFS
	for i; do
		IFS="="
		set -- $i
		unset IFS
		eval "$1=\"$2\""
	done
}

function hash {
	set -- $(sha1sum <<< "$*")
	echo "${1:0:5}"
}

declare -a dialog_args
declare -A time_hash
while read -r line; do
	readlog $line

	line="$name-$role-$race-$gender-$align $death on level $deathlev (HP: $hp [$maxhp])"
	h="$(hash "$line")"
	time_hash[$h]="$starttime"
	dialog_args+=( "$h" "$line" )
done < "$*"

trap '/bin/rm -f "$tempfile"' EXIT
tempfile="$(mktemp -t scores.XXXXXXX)"
exec 3> "$tempfile"
while true; do
	dialog --clear --output-fd 3 --title "High Scores" --menu "" 0 0 0 "${dialog_args[@]}" || break
	read -d '' < "$tempfile"
	echo -n > "$tempfile"
	dumplog="$HOME/nh/${time_hash[$REPLY]}.nh343.txt"
	#dumplog="~/nh/${time_hash[$REPLY]}.nh343.txt"
	if [[ -f "$dumplog" ]]; then
		less "$dumplog"
	else
		dialog --title "Error" --msgbox "No dumplog found" 5 20
	fi
done
exec 3>&-
